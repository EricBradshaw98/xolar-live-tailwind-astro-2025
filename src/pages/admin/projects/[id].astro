---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { mockProjects } from '../../../data/mockProjects.js';

export async function getStaticPaths() {
  return mockProjects.map((project) => ({
    params: { id: project.id.toString() },
  }));
}

const { id } = Astro.params;
const project = mockProjects.find((p) => p.id === parseInt(id || '1'));

if (!project) {
  return Astro.redirect('/admin/projects');
}
---

<AdminLayout title={`Edit Project #${project.id}`}>
  <div class="mb-8">
    <div class="flex items-center space-x-4 mb-4">
      <a
        href="/admin/projects"
        class="text-gray-600 hover:text-gray-900 transition-colors duration-200"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
          ></path>
        </svg>
      </a>
      <h1 class="text-3xl font-bold text-gray-900">Edit Project #{project.id}</h1>
    </div>
    <p class="text-gray-600">Update project information and settings</p>
  </div>

  <form id="project-form" class="space-y-6">
    <input type="hidden" name="id" value={project.id} />

    <!-- Basic Information -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2">
          <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
            Project Title *
          </label>
          <input
            type="text"
            id="title"
            name="title"
            required
            value={project.title}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div class="md:col-span-2">
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Project Description *
          </label>
          <textarea
            id="description"
            name="description"
            required
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          >{project.description}</textarea>
        </div>

        <div>
          <label for="projectType" class="block text-sm font-medium text-gray-700 mb-2">
            Project Type *
          </label>
          <select
            id="projectType"
            name="projectType"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          >
            <option value="Residential" selected={project.projectType === 'Residential'}>
              Residential
            </option>
            <option value="Commercial" selected={project.projectType === 'Commercial'}>
              Commercial
            </option>
          </select>
        </div>

        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
            Location *
          </label>
          <input
            type="text"
            id="location"
            name="location"
            required
            value={project.location}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="estimatedValue" class="block text-sm font-medium text-gray-700 mb-2">
            Estimated Value *
          </label>
          <input
            type="text"
            id="estimatedValue"
            name="estimatedValue"
            required
            value={project.estimatedValue}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="deadline" class="block text-sm font-medium text-gray-700 mb-2">
            Bid Deadline *
          </label>
          <input
            type="date"
            id="deadline"
            name="deadline"
            required
            value={new Date(project.deadline).toISOString().split('T')[0]}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
          <select
            id="status"
            name="status"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          >
            <option value="Open" selected={project.status === 'Open'}>Open</option>
            <option value="In Progress" selected={project.status === 'In Progress'}>
              In Progress
            </option>
            <option value="Closed" selected={project.status === 'Closed'}>Closed</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Current Bid Count</label>
          <div class="px-4 py-2 bg-gray-50 rounded-lg text-gray-900 font-medium">
            {project.bidCount} bids
          </div>
        </div>
      </div>
    </div>

    <!-- Technical Specifications -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Technical Specifications</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="systemSize" class="block text-sm font-medium text-gray-700 mb-2">
            System Size *
          </label>
          <input
            type="text"
            id="systemSize"
            name="systemSize"
            required
            value={project.specifications.systemSize}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="panelCount" class="block text-sm font-medium text-gray-700 mb-2">
            Panel Count *
          </label>
          <input
            type="number"
            id="panelCount"
            name="panelCount"
            required
            value={project.specifications.panelCount}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="roofType" class="block text-sm font-medium text-gray-700 mb-2">
            Roof Type *
          </label>
          <input
            type="text"
            id="roofType"
            name="roofType"
            required
            value={project.specifications.roofType}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="roofPitch" class="block text-sm font-medium text-gray-700 mb-2">
            Roof Pitch *
          </label>
          <input
            type="text"
            id="roofPitch"
            name="roofPitch"
            required
            value={project.specifications.roofPitch}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="utilityCompany" class="block text-sm font-medium text-gray-700 mb-2">
            Utility Company *
          </label>
          <input
            type="text"
            id="utilityCompany"
            name="utilityCompany"
            required
            value={project.specifications.utilityCompany}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="electricalPanelSize" class="block text-sm font-medium text-gray-700 mb-2">
            Electrical Panel Size *
          </label>
          <input
            type="text"
            id="electricalPanelSize"
            name="electricalPanelSize"
            required
            value={project.specifications.electricalPanelSize}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>
      </div>
    </div>

    <!-- Equipment Details -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Equipment Details</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="panels" class="block text-sm font-medium text-gray-700 mb-2">
            Solar Panels *
          </label>
          <input
            type="text"
            id="panels"
            name="panels"
            required
            value={project.equipment.panels}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="inverter" class="block text-sm font-medium text-gray-700 mb-2">
            Inverter *
          </label>
          <input
            type="text"
            id="inverter"
            name="inverter"
            required
            value={project.equipment.inverter}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="mounting" class="block text-sm font-medium text-gray-700 mb-2">
            Mounting System *
          </label>
          <input
            type="text"
            id="mounting"
            name="mounting"
            required
            value={project.equipment.mounting}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="battery" class="block text-sm font-medium text-gray-700 mb-2">
            Battery Storage
          </label>
          <input
            type="text"
            id="battery"
            name="battery"
            value={project.equipment.battery}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div>
          <label for="monitoring" class="block text-sm font-medium text-gray-700 mb-2">
            Monitoring System *
          </label>
          <input
            type="text"
            id="monitoring"
            name="monitoring"
            required
            value={project.equipment.monitoring}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>
      </div>
    </div>

    <!-- Requirements -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Special Requirements</h2>
      <div id="requirements-container" class="space-y-3">
        {
          project.requirements.map((req) => (
            <div class="requirement-item flex items-center space-x-2">
              <input
                type="text"
                name="requirements[]"
                value={req}
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              />
              <button
                type="button"
                class="remove-requirement px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          ))
        }
      </div>
      <button
        type="button"
        id="add-requirement"
        class="mt-3 px-4 py-2 text-sm text-primary-600 hover:bg-primary-50 rounded-lg transition-colors duration-200 flex items-center"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"
          ></path>
        </svg>
        Add Requirement
      </button>
    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-between pt-6 border-t border-gray-200">
      <button
        type="button"
        id="delete-btn"
        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 font-medium"
      >
        Delete Project
      </button>
      <div class="flex items-center space-x-4">
        <a
          href="/admin/projects"
          class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200"
        >
          Cancel
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 font-medium"
        >
          Save Changes
        </button>
      </div>
    </div>
  </form>
</AdminLayout>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('project-form');
    const requirementsContainer = document.getElementById('requirements-container');
    const addRequirementBtn = document.getElementById('add-requirement');
    const deleteBtn = document.getElementById('delete-btn');

    // Add requirement
    addRequirementBtn?.addEventListener('click', function () {
      const requirementItem = document.createElement('div');
      requirementItem.className = 'requirement-item flex items-center space-x-2';
      requirementItem.innerHTML = `
        <input
          type="text"
          name="requirements[]"
          placeholder="Enter a requirement"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
        />
        <button
          type="button"
          class="remove-requirement px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;
      requirementsContainer?.appendChild(requirementItem);
    });

    // Remove requirement
    requirementsContainer?.addEventListener('click', function (e) {
      const target = e.target as HTMLElement;
      if (
        target.closest('.remove-requirement') &&
        requirementsContainer.querySelectorAll('.requirement-item').length > 1
      ) {
        target.closest('.requirement-item')?.remove();
      }
    });

    // Delete project
    deleteBtn?.addEventListener('click', function () {
      if (
        confirm(
          'Are you sure you want to delete this project? This action cannot be undone and will delete all associated bids.'
        )
      ) {
        const projectId = (document.querySelector('input[name="id"]') as HTMLInputElement)?.value;
        alert(
          `Delete project #${projectId} - This would call /api/admin/projects/${projectId} DELETE`
        );
        window.location.href = '/admin/projects';
      }
    });

    // Form submission
    form?.addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(form as HTMLFormElement);
      const projectData: any = {};

      formData.forEach((value, key) => {
        if (key !== 'requirements[]') {
          projectData[key] = value;
        }
      });

      const requirements = formData.getAll('requirements[]').filter((r) => r !== '');
      projectData.requirements = requirements;

      console.log('Updated Project Data:', projectData);
      alert(
        'Project updated successfully!\n\nIn production, this would PUT to: /api/admin/projects/' +
          projectData.id
      );

      window.location.href = '/admin/projects';
    });
  });
</script>
